@startuml ScooterLifecycle
hide empty description
title Scooter Sharing Lifecycle Statechart

[*] --> Available

Available : entry / publishAvailability()
Available : do / broadcastLiveLocation()
Available : exit / logStatusChange("reserved")

Available --> ReservationPending : reserveRequested / holdScooterForRider()
Available --> Charging : batteryLowDetected / autoDispatchToCharging()
Available --> OutOfService : technicianPickup / assignTechnician()

ReservationPending : entry / startReservationTimer()
ReservationPending : exit / clearReservationTimer()
ReservationPending --> Available : reservationExpired / releaseHold()
ReservationPending --> RideInProgress : unlockViaApp [batteryLevel >= 20] / startBillingClock()
ReservationPending --> RideInProgress : unlockViaKeycard [batteryLevel >= 20] / startBillingClock()
ReservationPending --> OutOfService : unlockViaApp [batteryLevel < 20] / blockRideForCharging()

state PostRideProcessing
PostRideProcessing : entry / computeRideCost()
PostRideProcessing : do / awaitPaymentConfirmation()
PostRideProcessing : exit / pushInvoice()

state "Ride In Progress" as RideInProgress {
	state RideHistory <<H*>>
	[*] --> Navigating : unlockConfirmed / startTripSession()

	Navigating : entry / updateScooterStatus("inUse")
	Navigating : do / streamTelemetry()
	Navigating --> RidePaused : connectionLost / alertRiderOfPause()
	Navigating --> ParkingCheck : riderEndRide / startParkingValidation()

	RidePaused : exit / syncTripGap()
	RidePaused --> RideHistory : connectionRecovered / resumeGuidance()
	RidePaused --> ParkingCheck : riderEndRide / enforceParkingCheck()

	ParkingCheck : do / validateZoneWithMap()
	ParkingCheck --> Navigating : zoneInvalid / promptReposition()
	ParkingCheck --> PostRideProcessing : zoneValid / finalizeTripData()
}

RideInProgress --> OutOfService : technicianPickup / abortTripForRecovery()

PostRideProcessing --> Available : paymentAuthorized [batteryLevel >= 30] / publishAvailability()
PostRideProcessing --> Charging : paymentAuthorized [batteryLevel < 30] / queueForCharging()
PostRideProcessing --> OutOfService : technicianPickup / rerouteTechnician()

state Charging
Charging : entry / markStatus("charging")
Charging : do / monitorBattery()
Charging : exit / logChargeSession()

Charging --> Available : chargeCompleted / publishAvailability()
Charging --> OutOfService : chargerFault / escalateToTechnician()

state OutOfService
OutOfService : entry / flagScooterAsBlocked()
OutOfService : do / technicianDiagnose()
OutOfService : exit / updateStatusLog()

OutOfService --> Charging : maintenanceComplete [batteryLevel < 80] / sendToChargingBay()
OutOfService --> Available : maintenanceComplete [batteryLevel >= 80] / reopenForFleet()

@enduml
